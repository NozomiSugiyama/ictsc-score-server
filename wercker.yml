box: ruby:2.3.0

build:
  steps:
    - script:
        name: set nodejs environment and install packages
        code: |
          curl -sL https://deb.nodesource.com/setup_6.x | bash -
          sudo apt-get install -y nodejs
          cd ui
          npm install
    - script:
        name: webpack build
        code: |
          cd ui
          npm run build:prod
          mv dist/* ../public/
    - bundle-install
    - script:
        name: migrate database
        code: bundle exec rake db:migrate
    - script:
        name: load seed data into database
        code: bundle exec rake db:seed_fu
    - script:
        name: run rspec
        code: bundle exec rspec spec
  after-steps:
    - wantedly/pretty-slack-notify:
        webhook_url: $SLACK_WEBHOOK_URL
deploy:
  steps:
    - internal/docker-push:
        registry: $REGISTRY_HOST
        username: $REGISTRY_USERNAME
        password: $REGISTRY_PASSWORD
        repository: $REGISTRY_REPOSITORY
        ports: "9999"
        working-dir: /pipeline/source
        cmd: ./wercker-run.sh
